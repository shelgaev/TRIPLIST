# bot.py
import asyncio
import json
import os
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

BOT_TOKEN = "8397933613:AAF_UzWrx3SR4vQg7Mgf_1EQ0a8Gim6k4gQ"  # ‚Üê –°–Æ–î–ê!
DATA_FILE = "shopping_list.json"

def load_list():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return []

def save_list(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    kb = [
        [types.KeyboardButton(text="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫")],
        [types.KeyboardButton(text="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É")],
        [types.KeyboardButton(text="–£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É")]
    ]
    markup = types.ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True)
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –¥–ª—è –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫ –≤ –ø–æ—Ö–æ–¥ üéí", reply_markup=markup)

@dp.message(lambda msg: msg.text == "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫")
async def show_list(message: Message):
    items = load_list()
    if not items:
        await message.answer("–°–ø–∏—Å–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç.")
    else:
        text = "üìã –°–ø–∏—Å–æ–∫:\n\n"
        for i, item in enumerate(items, 1):
            text += f"{i}. {item}\n"
        await message.answer(text)

@dp.message(lambda msg: msg.text == "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É")
async def add_item_start(message: Message):
    await message.answer("–ù–∞–ø–∏—à–∏: *–Ω–∞–∑–≤–∞–Ω–∏–µ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ + –µ–¥–∏–Ω–∏—Ü–∞*\n–ù–∞–ø—Ä–∏–º–µ—Ä: `–≤–æ–¥–∞ 5 –ª`")

@dp.message(
    lambda msg: msg.text not in ["–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫", "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É", "–£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É"]
    and not msg.text.startswith("/")
)
async def add_item(message: Message):
    items = load_list()
    items.append(message.text.strip())
    save_list(items)
    await message.answer("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!")

@dp.message(lambda msg: msg.text == "–£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É")
async def delete_item_start(message: Message):
    items = load_list()
    if not items:
        await message.answer("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.")
        return
    text = "–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:\n\n"
    for i, item in enumerate(items, 1):
        text += f"{i}. {item}\n"
    await message.answer(text)

@dp.message(lambda msg: msg.text.isdigit())
async def delete_item(message: Message):
    try:
        index = int(message.text) - 1
        items = load_list()
        if 0 <= index < len(items):
            removed = items.pop(index)
            save_list(items)
            await message.answer(f"üóë –£–¥–∞–ª–µ–Ω–æ: {removed}")
        else:
            await message.answer("–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä.")
    except:
        await message.answer("–û—à–∏–±–∫–∞. –ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —Ü–∏—Ñ—Ä–∞–º–∏.")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())